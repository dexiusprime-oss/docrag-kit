# Changelog

## [0.2.0] - 2024-12-22

### Архитектурное решение MCP переиндексации
- **MAJOR**: Реализована изолированная архитектура subprocess для MCP совместимости
- **NEW**: Добавлен модуль `docrag.mcp_reindex_worker` для изолированных операций с базой данных
- **NEW**: Добавлена команда `docrag test-isolated-reindex` для тестирования новой архитектуры
- **IMPROVEMENT**: Многостратегийная переиндексация (subprocess → in-process → fallback)
- **IMPROVEMENT**: Расширенный VectorDBManager с возможностями принудительного удаления

### Решение критической проблемы
- **FIXED**: Проблема блокировки ChromaDB/SQLite в MCP контексте
- **FIXED**: Ошибки "unable to open database file" при MCP переиндексации
- **ARCHITECTURE**: Процессная изоляция для предотвращения конфликтов файловых блокировок

### Новые возможности
- **Изолированный worker процесс**: Безопасная переиндексация без конфликтов блокировок
- **Многостратегийный подход**: Автоматический fallback при сбоях стратегий
- **Улучшенная диагностика**: Структурированный JSON вывод для отладки
- **Тихий режим**: Подавление прогресс-сообщений в MCP контексте

### Техническое
- Добавлен `src/docrag/mcp_reindex_worker.py` для изолированной переиндексации
- Улучшен `VectorDBManager._force_delete_database()` с агрессивными стратегиями
- Обновлен MCP сервер с `_try_subprocess_reindex()` и `_try_inprocess_reindex()`
- Исправлен вывод JSON в worker процессе (убраны лишние сообщения)

### Статус
- ✅ Архитектура реализована и протестирована
- ✅ Изолированный worker возвращает чистый JSON
- ✅ MCP сервер поддерживает все 4 инструмента
- ✅ Graceful fallback к CLI при необходимости

## [0.1.8] - 2024-12-22

### Критические исправления
- **ИСПРАВЛЕНО**: Критическая ошибка блокировки базы данных в MCP контексте
- **ИСПРАВЛЕНО**: Ошибки "unable to open database file" при MCP переиндексации
- **ИСПРАВЛЕНО**: Конфликты доступа к базе данных между CLI и MCP процессами

### Новые возможности
- **Улучшенный MCP инструмент `reindex_docs`**: Безопасная переиндексация с обработкой блокировок
- **Команда `docrag fix-database`**: Автоматическое исправление проблем с базой данных
  - Удаление lock-файлов
  - Исправление прав доступа
  - Восстановление поврежденной базы данных
- **Команда `docrag debug-mcp`**: Комплексная диагностика синхронизации CLI/MCP
  - Проверка путей и конфигурации
  - Диагностика прав доступа
  - Анализ состояния базы данных

### Улучшения
- **Безопасное управление базой данных**: Механизмы повторных попыток и cleanup
- **Автоматические предупреждения**: Уведомления об устаревших данных в поиске
- **Улучшенная обработка ошибок**: Понятные сообщения с рекомендациями по исправлению
- **MCP-совместимые операции**: Неблокирующие проверки и операции

### Техническое
- Добавлена зависимость `psutil>=5.8.0` для диагностики процессов
- Улучшена архитектура VectorDBManager с безопасными операциями
- Расширена система диагностики и восстановления

## [0.1.7] - 2024-12-14

### Новые возможности
- **Новый MCP инструмент `reindex_docs`**: Умная переиндексация с автоматическим обнаружением изменений
- **Команда `docrag fix-database`**: Исправление проблем с базой данных (readonly, права доступа, блокировки)
- **Команда `docrag debug-mcp`**: Диагностика проблем синхронизации CLI и MCP
- **Команда `docrag update`**: Обновление существующих проектов с новыми функциями

### Улучшения
- Предупреждения об устаревших данных в `search_docs` и `answer_question`
- Автоматические рекомендации по переиндексации
- Улучшенная производительность для больших проектов
- Лучшая обработка ошибок базы данных

### Исправления
- Решены проблемы с "readonly database" ошибками
- Исправлены проблемы с правами доступа к файлам базы данных
- Устранены блокировки файлов базы данных
- Исправлена синхронизация между CLI и MCP сервером

### Техническое
- Добавлена зависимость `psutil>=5.8.0` для мониторинга процессов
- Улучшена архитектура управления базой данных
- Расширена диагностика системы

## [0.1.6] - 2024-12-13

### Новые возможности
- Базовая функциональность RAG системы
- MCP интеграция с Kiro AI
- Поддержка OpenAI и Google Gemini
- Шаблоны проектов (general, symfony, ios)

### MCP инструменты
- `search_docs`: Быстрый семантический поиск
- `answer_question`: AI-генерированные ответы
- `list_indexed_docs`: Список индексированных файлов

### CLI команды
- `docrag init`: Инициализация проекта
- `docrag index`: Индексация документации
- `docrag reindex`: Полная переиндексация
- `docrag config`: Управление конфигурацией
- `docrag mcp-config`: Настройка MCP интеграции